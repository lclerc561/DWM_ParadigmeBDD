<?php
require_once __DIR__ . '/../vendor/autoload.php';

use MongoDB\Client;

try {
    $client = new Client("mongodb://mongo:27017");
    $collection = $client->chopizza->produits;

    echo "<h1>Résultats des requêtes MongoDB</h1>";

    echo "<h3>1. Liste des produits (Libellés)</h3>";
    $results = $collection->find();
    foreach ($results as $doc) {
        echo $doc['libelle'] . "<br>";
    }

    echo "<h3>2. Compter les produits</h3>";
    $count = $collection->countDocuments();
    echo "Nombre total de produits : $count <br>";

    echo "<h3>3. Produits triés par numéro décroissant</h3>";
    $results = $collection->find([], ['sort' => ['numero' => -1]]);
    foreach ($results as $doc) {
        echo "N°" . $doc['numero'] . " : " . $doc['libelle'] . "<br>";
    }

    echo "<h3>4. Le produit 'Margherita'</h3>";
    $p = $collection->findOne(['libelle' => 'Margherita']);
    echo $p ? "Trouvé : " . $p['description'] : "Non trouvé";
    echo "<br>";

    echo "<h3>5. Produits de la catégorie 'Boissons'</h3>";
    $results = $collection->find(['categorie' => 'Boissons']);
    foreach ($results as $doc) {
        echo $doc['libelle'] . "<br>";
    }

    echo "<h3>6. Projection : Catégorie, Numéro, Libellé</h3>";
    $results = $collection->find([], [
        'projection' => [
            'categorie' => 1,
            'numero' => 1,
            'libelle' => 1
        ]
    ]);
    foreach ($results as $doc) {
        echo "[{$doc['categorie']}] N°{$doc['numero']} - {$doc['libelle']}<br>";
    }

    echo "<h3>7. Projection avec Tarifs</h3>";
    $results = $collection->find([], [
        'projection' => [
            'categorie' => 1,
            'numero' => 1,
            'libelle' => 1,
            'tarifs' => 1
        ]
    ]);
    foreach ($results as $doc) {
        echo "<b>{$doc['libelle']}</b> : ";
        foreach ($doc['tarifs'] as $t) {
            echo "{$t['taille']} ({$t['tarif']}€) ";
        }
        echo "<br>";
    }

    echo "<h3>8. Produits avec un tarif < 8.0</h3>";
    $results = $collection->find(['tarifs.tarif' => ['$lt' => 8.0]]);
    foreach ($results as $doc) {
        echo $doc['libelle'] . "<br>";
    }

    echo "<h3>9. Produits avec un tarif grande taille < 8.0</h3>";
    $results = $collection->find([
        'tarifs' => [
            '$elemMatch' => [
                'taille' => 'grande',
                'tarif' => ['$lt' => 8.0]
            ]
        ]
    ]);
    foreach ($results as $doc) {
        echo $doc['libelle'] . "<br>";
    }

    echo "<h3>10. Insertion d'un nouveau produit</h3>";
    $existe = $collection->findOne(['numero' => 999]);
    if (!$existe) {
        $results = $collection->insertOne([
            'numero' => 999,
            'libelle' => 'Pizza Speciale Dev',
            'categorie' => 'Pizzas',
            'description' => 'Une pizza créée par PHP',
            'tarifs' => [
                ['taille' => 'normale', 'tarif' => 12.5]
            ]
        ]);
        echo "Produit inséré avec l'ID : " . $results->getInsertedId();
    } else {
        echo "Le produit de test existe déjà.";
    }
    echo "<br>";

    echo "<h3>11. Recettes associées au produit 1 (Lookup)</h3>";
    $results = $collection->aggregate([
        [ '$match' => ['numero' => 1] ],
        [ '$lookup' => [
            'from' => 'recettes',
            'localField' => 'recettes',
            'foreignField' => '_id',
            'as' => 'recettes_complet'
        ]]
    ]);

    foreach ($results as $doc) {
        echo "Produit : " . $doc['libelle'] . "<br>";
        echo "<ul>";
        if (isset($doc['recettes_complet'])) {
            foreach ($doc['recettes_complet'] as $recette) {
                echo "<li>Recette : " . $recette['nom'] . " (Difficulté : " . $recette['difficulte'] . ")</li>";
            }
        }
        echo "</ul>";
    }

    // =========================================================
    // PARTIE 2 : NOUVELLES REQUÊTES
    // =========================================================
    echo "<hr><h1>Partie 2 : Requêtes en PHP</h1>";

    // 1. Afficher la liste des produits : numero, categorie, libelle
    echo "<h3>1. Liste simple (Numéro, Catégorie, Libellé)</h3>";
    $results = $collection->find([], [
        'projection' => [
            'numero' => 1,
            'categorie' => 1,
            'libelle' => 1,
            '_id' => 0
        ]
    ]);
    foreach ($results as $p) {
        echo "N°{$p['numero']} - [{$p['categorie']}] {$p['libelle']}<br>";
    }

    // 2. Afficher le produit numéro 6 (Libellé, Catégorie, Description, Tarifs)
    echo "<h3>2. Détail du produit N°6</h3>";
    $p6 = $collection->findOne(
        ['numero' => 6],
        [
            'projection' => [
                'libelle' => 1,
                'categorie' => 1,
                'description' => 1,
                'tarifs' => 1,
                '_id' => 0
            ]
        ]
    );

    if ($p6) {
        echo "<strong>{$p6['libelle']}</strong> ({$p6['categorie']})<br>";
        echo "<em>{$p6['description']}</em><br>";
        echo "Tarifs : ";
        foreach ($p6['tarifs'] as $t) {
            echo "{$t['taille']}={$t['tarif']}€ ";
        }
    } else {
        echo "Produit 6 introuvable.";
    }

    // 3. Produits dont le tarif en taille "normale" est <= 3.0
    echo "<h3>3. Produits pas chers (taille normale <= 3.0€)</h3>";
    // Utilisation de $elemMatch pour vérifier taille ET prix dans le même sous-objet
    $results = $collection->find([
        'tarifs' => [
            '$elemMatch' => [
                'taille' => 'normale',
                'tarif' => ['$lte' => 3.0]
            ]
        ]
    ]);
    foreach ($results as $p) {
        echo "- {$p['libelle']}<br>";
    }

    // 4. Liste des produits associés à 4 recettes
    echo "<h3>4. Produits ayant exactement 4 recettes</h3>";
    // $size permet de filtrer sur la taille d'un tableau
    $results = $collection->find([
        'recettes' => ['$size' => 4]
    ]);
    foreach ($results as $p) {
        echo "- {$p['libelle']} (N°{$p['numero']})<br>";
    }

    // 5. Produit N°6 avec le détail des recettes associées
    echo "<h3>5. Recettes du produit N°6</h3>";
    $results = $collection->aggregate([
        ['$match' => ['numero' => 6]], 
        ['$lookup' => [
            'from' => 'recettes',       
            'localField' => 'recettes', 
            'foreignField' => '_id',    
            'as' => 'details_recettes'  
        ]]
    ]);

    foreach ($results as $doc) {
        echo "Produit : <b>{$doc['libelle']}</b><br>";
        echo "Recettes associées :<ul>";
        if (isset($doc['details_recettes'])) {
            foreach ($doc['details_recettes'] as $r) {
                echo "<li>{$r['nom']} (Diff: {$r['difficulte']})</li>";
            }
        }
        echo "</ul>";
    }

    // 6. Fonction getProduitInfo et affichage JSON
    echo "<h3>6. Fonction PHP et JSON</h3>";

    // On définit la fonction
    if (!function_exists('getProduitInfo')) {
        function getProduitInfo($collection, $numero, $tailleDemande) {
            $produit = $collection->findOne(['numero' => $numero]);
            if (!$produit) return ["erreur" => "Produit introuvable"];

            $tarifTrouve = null;
            foreach ($produit['tarifs'] as $t) {
                if ($t['taille'] === $tailleDemande) {
                    $tarifTrouve = $t['tarif'];
                    break;
                }
            }

            if ($tarifTrouve === null) return ["erreur" => "Taille inexistante"];

            return [
                'numero' => $produit['numero'],
                'libelle' => $produit['libelle'],
                'categorie' => $produit['categorie'],
                'taille' => $tailleDemande,
                'tarif' => $tarifTrouve
            ];
        }
    }

    // On appelle la fonction pour le produit 2, taille 'grande'
    $info = getProduitInfo($collection, 2, 'grande');

    // On affiche le résultat encodé en JSON
    echo "<pre>" . json_encode($info, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "</pre>";

} catch (Exception $e) {
    echo "Erreur : " . $e->getMessage();
}
?>